const xlsx = require("xlsx");
const { parseWeeks } = require("../utils/parseWeeks");

function parseExcel(file) {
  if (!file) throw new Error("No file");

  const workbook = xlsx.read(file.buffer, { type: "buffer" });
  const sheet = workbook.Sheets[workbook.SheetNames[0]];

  const rows = xlsx.utils.sheet_to_json(sheet, { header: 1 });
  const headerRowIndex = rows.findIndex(r => r.includes("Mã_HP"));

  const headers = rows[headerRowIndex];
  const dataRows = rows.slice(headerRowIndex + 1);

  return dataRows
    .filter(r => r[headers.indexOf("Mã_HP")])
    .map(r => ({
      maHP: r[headers.indexOf("Mã_HP")],
      maLop: r[headers.indexOf("Mã_lớp")],
      maLopKem: r[headers.indexOf("Mã_lớp_kèm")] || null,
      tn: Boolean(r[headers.indexOf("Cần_TN")]),
      sessions: [{
        thu: Number(r[headers.indexOf("Thứ")]),
        start: Number(r[headers.indexOf("BĐ")]),
        end: Number(r[headers.indexOf("KT")]),
        tuan: parseWeeks(r[headers.indexOf("Tuần")]),
        phong: r[headers.indexOf("Phòng")],
        so: r[headers.indexOf("Buổi_số")]
      }]
    }));
}

module.exports = { parseExcel };
